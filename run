#!/bin/bash

cmd=
[ -n "$QEMU" ] || {
	QEMU=qemu-system-x86_64
	CEQEMU=$HOME/CE/bin/qemu-system-x86_64
	[ -x "$CEQEMU" ] && QEMU=$CEQEMU
}
CEHDPATH=${CEHDPATH:-$HOME/CE/share/hd.img}
BOOT=${BOOT:-$HOME/CE/lib/ce/boot.bin}
MEM=${MEM:-8}

cmd="$QEMU \
	-kernel $BOOT \
	-initrd build/sistema \
	-drive file=.swap,format=raw,cache=unsafe \
	-no-reboot \
	-m $MEM"

if [ "$1" == -g ]; then
	cmd="$cmd -s -append \"-s\""
	shift
fi
	
trap 'stty sane' exit

if [ "$AUTOCORR" == 1 ]; then
	cmd="$cmd -nographic"
else
	cmd="$cmd -serial stdio"
fi

if [ -f "$CDEPATH" ]; then
	cmd="$cmd -hdc \"$CDEPATH\""
fi

show_log="| util/show_log.pl"
if [ -n "$CERAW" ]; then
	show_log=
fi

echo Eseguo: $cmd
eval $cmd $show_log
